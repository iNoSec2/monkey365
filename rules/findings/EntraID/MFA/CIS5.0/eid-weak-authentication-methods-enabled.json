{
  "args": [],
  "provider": "Microsoft365",
  "serviceType": "EntraID",
  "serviceName": "Microsoft 365",
  "displayName": "Ensure weak authentication methods are disabled",
  "description": "Authentication methods support a wide variety of scenarios for signing in to Microsoft 365 resources. Some of these methods are inherently more secure than others but require more investment in time to get users enrolled and operational.\n\nSMS and Voice Call rely on telephony carrier communication methods to deliver the authenticating factor.\n\nThe email one-time passcode feature is a way to authenticate B2B collaboration users when they can't be authenticated through other means, such as Microsoft Entra ID, Microsoft account (MSA), or social identity providers. When a B2B guest user tries to redeem your invitation or sign in to your shared resources, they can request a temporary passcode, which is sent to their email address. Then they enter this passcode to continue signing in.\n\nThe recommended state is to Disable these methods:\n\n*   SMS\n*   Voice Call\n*   Email OTP",
  "rationale": "The SMS and Voice call methods are vulnerable to SIM swapping which could allow an attacker to gain access to your Microsoft 365 account.",
  "impact": "Disabling Email OTP will prevent one-time pass codes from being sent to unverified guest users accessing Microsoft 365 resources on the tenant such as “@yahoo.com”. They will be required to use a personal Microsoft account, a managed Microsoft Entra account, be part of a federation or be configured as a guest in the host tenant's Microsoft Entra ID.",
  "remediation": {
    "text": "To remediate using the UI:\n1. Navigate to Microsoft Entra admin center https://entra.microsoft.com/.\n2. Click to expand Protection select Authentication methods.\n3. Select Policies.\n4. Inspect each method that is out of compliance and remediate:\n    *   Click on the method to open it.\n    *   Change the Enable toggle to the off position.\n    *   Click Save.\n\nNote: If the save button remains greyed out after toggling a method off, then first turn it back on and then change the position of the Target selection (all users or select groups). Turn the method off again and save. This was observed to be a bug in the UI at the time this document was published.\n\nTo remediate using Powershell:\n1. Connect to Graph using Connect-MgGraph -Scopes \"Policy.ReadWrite.AuthenticationMethod\"\n2. Run the following to disable all three authentication methods:\n   $params = @(\n     @{ Id = \"Sms\"; State = \"disabled\" },\n     @{ Id = \"Voice\"; State = \"disabled\" },\n     @{ Id = \"Email\"; State = \"disabled\" }\n   )\n   Update-MgPolicyAuthenticationMethodPolicy -AuthenticationMethodConfigurations $params",
    "code": {
      "powerShell": null,
      "iac": null,
      "terraform": null,
      "other": null
    }
  },
  "recommendation": null,
  "references": [
    "https://learn.microsoft.com/en-us/entra/identity/authentication/conceptauthentication-methods-manage",
    "https://learn.microsoft.com/en-us/entra/external-id/one-time-passcode",
    "https://www.microsoft.com/en-us/microsoft-365-life-hacks/privacy-andsafety/what-is-sim-swapping"
  ],
  "compliance": [
    {
      "name": "CIS Microsoft 365 Foundations",
      "version": "5.0.0",
      "reference": "3.1.5" 
    }
  ],
  "level": "medium",
  "tags": [
    "CIS Microsoft 365 Foundations 5.0.0 3.1.5",
    "EntraID",
    "MFA"
  ],
  "rule": {
    "path": "Get-MonkeyMSGraphAuthenticationMethodsPolicy",
    "subPath": null,
    "selectCondition": "[?value[?id -in @('sms', 'voice')].state == 'enabled']", 
    "query": [],
    "shouldExist": null,
    "returnObject": null,
    "removeIfNotExists": null
  },
  "output": {
    "html": {
      "data": {
        "properties": {
          "id": "Method ID",
          "state": "State"
        },
        "expandObject": null
      },
      "table": "Normal",
      "decorate": [
        {
          "ItemName": "State",
          "ItemValue": "enabled",
          "className": "badge bg-danger larger-badge"
        }
      ],
      "emphasis": [],
      "actions": {
        "objectData": {
          "properties": ["*"],
          "expandObject": null,
          "limit": null
        },
        "showGoToButton": "True",
        "showModalButton": "True",
        "directLink": null
      }
    },
    "text": {
      "data": {
        "properties": {},
        "expandObject": null
      },
      "status": {
        "keyName": [],
        "message": "Weak authentication methods (SMS, Voice) are enabled.",
        "defaultMessage": null
      },
      "properties": {
        "resourceName": "id",
        "resourceId": "id",
        "resourceType": "Microsoft.Graph.AuthenticationMethodConfiguration"
      },
      "onlyStatus": false
    }
  },
  "idSuffix": "eid-weak-authentication-methods-enabled",
  "notes": ["This control is similar to 5.2.3.5. The selectCondition specifically checks for 'sms' or 'voice' being enabled. Email OTP is handled by a different CIS control or needs to be checked separately if covered by 3.1.5."],
  "categories": []
}