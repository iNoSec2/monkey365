{
  "args": [],
  "provider": "Microsoft365",
  "serviceType": "Exchange Online",
  "serviceName": "Microsoft 365",
  "displayName": "Ensure sign-in to shared mailboxes is blocked",
  "description": "Shared mailboxes are used when multiple people need access to the same mailbox, such as a company information or support email address, reception desk, or other function that might be shared by multiple people. Users with permissions to the group mailbox can send as or send on behalf of the mailbox email address if the administrator has given that user permissions to do that. This is particularly useful for help and support mailboxes because users can send emails from \"Contoso Support\" or \"Building A Reception Desk.\" Shared mailboxes are created with a corresponding user account using a system generated password that is unknown at the time of creation. The recommended state is Sign in blocked for Shared mailboxes.",
  "rationale": "The intent of the shared mailbox is the only allow delegated access from other mailboxes. An admin could reset the password, or an attacker could potentially gain access to the shared mailbox allowing the direct sign-in to the shared mailbox and subsequently the sending of email from a sender that does not have a unique identity. To prevent this, block sign-in for the account that is associated with the shared mailbox.",
  "impact": "No impact is expected as this is the intended configuration for shared mailboxes.",
  "remediation": {
    "text": "To remediate using the UI:\n1. Navigate to Microsoft 365 admin center https://admin.microsoft.com/\n2. Click to expand Teams & groups and select Shared mailboxes.\n3. Take note of all shared mailboxes.\n4. Click to expand Users and select Active users.\n5. Select a shared mailbox account to open it's properties pane and then select Block sign-in.\n6. Check the box for Block this user from signing in.\n7. Repeat for any additional shared mailboxes.\n\nTo remediate using PowerShell:\n1. Connect to Microsoft Graph using Connect-MgGraph -Scopes \"User.ReadWrite.All\"\n2. Connect to Exchange Online using Connect-ExchangeOnline.\n3. To disable sign-in for a single account:\n   $MBX = Get-EXOMailbox -Identity TestUser@example.com\n   Update-MgUser -UserId $MBX.ExternalDirectoryObjectId -AccountEnabled:$false\n4. The following will block sign-in to all Shared Mailboxes.\n   $MBX = Get-EXOMailbox -RecipientTypeDetails SharedMailbox\n   $MBX | ForEach-Object { Update-MgUser -UserId $_.ExternalDirectoryObjectId -AccountEnabled:$false }",
    "code": {
      "powerShell": null,
      "iac": null,
      "terraform": null,
      "other": null
    }
  },
  "recommendation": null,
  "references": [
    "https://learn.microsoft.com/en-us/microsoft-365/admin/email/about-sharedmailboxes?view=o365-worldwide",
    "https://learn.microsoft.com/en-us/microsoft-365/admin/email/create-a-sharedmailbox?view=o365-worldwide#block-sign-in-for-the-shared-mailbox-account",
    "https://learn.microsoft.com/en-us/microsoft-365/enterprise/block-user-accountswith-microsoft-365-powershell?view=o365-worldwide#block-individual-useraccounts"
  ],
  "compliance": [
    {
      "name": "CIS Microsoft 365 Foundations",
      "version": "5.0.0",
      "reference": "1.2.2"
    }
  ],
  "level": "medium",
  "tags": [
    "CIS Microsoft 365 Foundations 5.0.0 1.2.2",
    "Exchange Online",
    "MailBoxes"
  ],
  "rule": {
    "path": "Get-MonkeyRestEXOCASMailbox",
    "subPath": null,
    "selectCondition": "[?isSecurityPrincipal == 'False' -and signInBlocked -ne 'True']",
    "query": [],
    "shouldExist": null,
    "returnObject": null,
    "removeIfNotExists": null
  },
  "output": {
    "html": {
      "data": {
        "properties": {
          "displayName": "Display Name",
          "userPrincipalName": "User Principal Name",
          "signInBlocked": "Sign-in Blocked"
        },
        "expandObject": null
      },
      "table": "Normal",
      "decorate": [
        {
          "ItemName": "Sign-in Blocked",
          "ItemValue": "False",
          "className": "badge bg-danger larger-badge"
        }
      ],
      "emphasis": [],
      "actions": {
        "objectData": {
          "properties": ["*"],
          "expandObject": null,
          "limit": null
        },
        "showGoToButton": "True",
        "showModalButton": "True",
        "directLink": null
      }
    },
    "text": {
      "data": {
        "properties": {},
        "expandObject": null
      },
      "status": {
        "keyName": [],
        "message": "Shared mailboxes found where sign-in is not blocked.",
        "defaultMessage": null
      },
      "properties": {
        "resourceName": "displayName",
        "resourceId": "externalDirectoryObjectId",
        "resourceType": "Microsoft.Exchange.Data.Directory.Management.CASMailbox"
      },
      "onlyStatus": false
    }
  },
  "idSuffix": "exo-sign-in-shared-mailbox-enabled",
  "notes": [],
  "categories": []
}