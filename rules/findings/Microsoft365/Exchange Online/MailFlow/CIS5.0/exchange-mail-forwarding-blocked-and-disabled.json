{
  "args": [],
  "provider": "Microsoft365",
  "serviceType": "Exchange Online",
  "serviceName": "Microsoft 365",
  "displayName": "Ensure all forms of mail forwarding are blocked and/or disabled",
  "description": "Exchange Online offers several methods of managing the flow of email messages. These are Remote domain, Transport Rules, and Anti-spam outbound policies. These methods work together to provide comprehensive coverage for potential automatic forwarding channels:\n\n*   Outlook forwarding using inbox rules.\n*   Outlook forwarding configured using OOF rule.\n*   OWA forwarding setting (ForwardingSmtpAddress).\n*   Forwarding set by the admin using EAC (ForwardingAddress).\n*   Forwarding using Power Automate / Flow.\n\nEnsure a Transport rule and Anti-spam outbound policy are used to block mail forwarding.\n\nNOTE: Any exclusions should be implemented based on organizational policy.",
  "rationale": "Attackers often create these rules to exfiltrate data from your tenancy, this could be accomplished via access to an end-user account or otherwise. An insider could also use one of these methods as a secondary channel to exfiltrate sensitive data.",
  "impact": "Care should be taken before implementation to ensure there is no business need for case-by-case auto-forwarding. Disabling auto-forwarding to remote domains will affect all users and in an organization. Any exclusions should be implemented based on organizational policy.",
  "remediation": {
    "text": "Note: Remediation is a two step procedure as follows:\n\nSTEP 1: Transport rules\nTo remediate using the UI:\n1. Select Exchange to open the Exchange admin center.\n2. Select Mail Flow then Rules.\n3. For each rule that redirects email to external domains, select the rule and click the 'Delete' icon.\n\nTo remediate using PowerShell:\n1. Connect to Exchange Online using Connect-ExchangeOnline.\n2. Run the following PowerShell command:\n   Remove-TransportRule {RuleName}\n\nSTEP 2: Anti-spam outbound policy\nTo remediate using the UI:\n1. Navigate to Microsoft 365 Defender https://security.microsoft.com/\n2. Expand E-mail & collaboration then select Policies & rules.\n3. Select Threat policies > Anti-spam.\n4. Select Anti-spam outbound policy (default)\n5. Click Edit protection settings\n6. Set Automatic forwarding rules dropdown to Off - Forwarding is disabled and click Save\n7. Repeat steps 4-6 for any additional higher priority, custom policies.\n\nTo remediate using PowerShell:\n1. Connect to Exchange Online using Connect-ExchangeOnline.\n2. Run the following PowerShell command:\n   Set-HostedOutboundSpamFilterPolicy -Identity {policyName} -AutoForwardingMode Off\n3. To remove AutoForwarding from all outbound policies you can also run:\n   Get-HostedOutboundSpamFilterPolicy | Set-HostedOutboundSpamFilterPolicy -AutoForwardingMode Off",
    "code": {
      "powerShell": null,
      "iac": null,
      "terraform": null,
      "other": null
    }
  },
  "recommendation": null,
  "references": [
    "https://learn.microsoft.com/en-us/exchange/security-and-compliance/mail-flowrules/mail-flow-rules",
    "https://techcommunity.microsoft.com/t5/exchange-team-blog/all-you-need-toknow-about-automatic-email-forwarding-in/bap/2074888#:~:text=%20%20%20Automatic%20forwarding%20option%20%20,%20",
    "https://learn.microsoft.com/en-us/defender-office-365/outbound-spam-policiesexternal-email-forwarding?view=o365-worldwide"
  ],
  "compliance": [
    {
      "name": "CIS Microsoft 365 Foundations",
      "version": "5.0.0",
      "reference": "8.2.1" 
    }
  ],
  "level": "medium",
  "tags": [
    "CIS Microsoft 365 Foundations 5.0.0 8.2.1",
    "Exchange Online",
    "MailFlow"
  ],
  "rule": {
    "path": "Get-MonkeyEXOOutboundSpamFilterPolicy",
    "subPath": null,
    "selectCondition": "[?autoForwardingMode -ne 'Off']",
    "query": [],
    "shouldExist": null,
    "returnObject": null,
    "removeIfNotExists": null
  },
  "output": {
    "html": {
      "data": {
        "properties": {
          "name": "Policy Name",
          "autoForwardingMode": "Auto Forwarding Mode"
        },
        "expandObject": null
      },
      "table": "Normal",
      "decorate": [
        {
          "ItemName": "Auto Forwarding Mode",
          "ItemValue": "On",
          "className": "badge bg-danger larger-badge"
        },
        {
          "ItemName": "Auto Forwarding Mode",
          "ItemValue": "Automatic", 
          "className": "badge bg-danger larger-badge"
        }
      ],
      "emphasis": [],
      "actions": {
        "objectData": {
          "properties": ["*"],
          "expandObject": null,
          "limit": null
        },
        "showGoToButton": "True",
        "showModalButton": "True",
        "directLink": null
      }
    },
    "text": {
      "data": {
        "properties": {},
        "expandObject": null
      },
      "status": {
        "keyName": [],
        "message": "Mail forwarding via Outbound Spam Filter Policies is not set to 'Off'.",
        "defaultMessage": null
      },
      "properties": {
        "resourceName": "name",
        "resourceId": "identity",
        "resourceType": "Microsoft.Exchange.Management.Hosted.ContentFilter.HostedOutboundSpamFilterPolicy"
      },
      "onlyStatus": false
    }
  },
  "idSuffix": "exchange-mail-forwarding-blocked-and-disabled",
  "notes": ["This control is similar to 6.2.1. It specifically checks the Anti-spam outbound policy part."],
  "categories": []
}