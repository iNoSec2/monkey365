{
  "args": [],
  "provider": "Microsoft365",
  "serviceType": "Exchange Online",
  "serviceName": "Microsoft 365",
  "displayName": "Ensure comprehensive attachment filtering is applied",
  "description": "The Common Attachment Types Filter lets a user block known and custom malicious file types from being attached to emails. The policy provided by Microsoft covers 53 extensions, and an additional custom list of extensions can be defined.\n\nThe list of 184 extensions provided in this recommendation is comprehensive but not exhaustive.",
  "rationale": "Blocking known malicious file types can help prevent malware-infested files from infecting a host or performing other malicious attacks such as phishing and data extraction.\n\nDefining a comprehensive list of attachments can help protect against additional unknown and known threats. Many legacy file formats, binary files and compressed files have been used as delivery mechanisms for malicious software. Organizations can protect themselves from Business E-mail Compromise (BEC) by allow-listing only the file types relevant to their line of business and blocking all others.",
  "impact": "For file types that are business necessary users will need to use other organizationally approved methods to transfer blocked extension types between business partners.",
  "remediation": {
    "text": "To Remediate using PowerShell:\n1. Connect to Exchange Online using Connect-ExchangeOnline.\n2. Run the following script:\n\n# Create an attachment policy and associated rule. The rule is\n# intentionally disabled allowing the org to enable it when ready\n$Policy = @{\n  Name                                   = \"CIS L2 Attachment Policy\"\n  EnableFileFilter                       = $true\n  ZapEnabled                             = $true\n  EnableInternalSenderAdminNotifications = $true\n  InternalSenderAdminAddress             = 'admin@contoso.com' # Change this.\n}\n$L2Extensions = @(\n  \"7z\", \"a3x\", \"ace\", \"ade\", \"adp\", \"ani\", \"app\", \"appinstaller\",\n  \"applescript\", \"application\", \"appref-ms\", \"appx\", \"appxbundle\", \"arj\",\n  \"asd\", \"asx\", \"bas\", \"bat\", \"bgi\", \"bz2\", \"cab\", \"chm\", \"cmd\", \"com\",\n  \"cpl\", \"crt\", \"cs\", \"csh\", \"daa\", \"dbf\", \"dcr\", \"deb\",\n  \"desktopthemepackfile\", \"dex\", \"diagcab\", \"dif\", \"dir\", \"dll\", \"dmg\",\n  \"doc\", \"docm\", \"dot\", \"dotm\", \"elf\", \"eml\", \"exe\", \"fxp\", \"gadget\", \"gz\",\n  \"hlp\", \"hta\", \"htc\", \"htm\", \"html\", \"hwpx\", \"ics\", \"img\",\n  \"inf\", \"ins\", \"iqy\", \"iso\", \"isp\", \"jar\", \"jnlp\", \"js\", \"jse\", \"kext\",\n  \"ksh\", \"lha\", \"lib\", \"library-ms\", \"lnk\", \"lzh\", \"macho\", \"mam\", \"mda\",\n  \"mdb\", \"mde\", \"mdt\", \"mdw\", \"mdz\", \"mht\", \"mhtml\", \"mof\", \"msc\", \"msi\",\n  \"msix\", \"msp\", \"msrcincident\", \"mst\", \"ocx\", \"odt\", \"ops\", \"oxps\", \"pcd\",\n  \"pif\", \"plg\", \"pot\", \"potm\", \"ppa\", \"ppam\", \"ppkg\", \"pps\", \"ppsm\", \"ppt\",\n  \"pptm\", \"prf\", \"prg\", \"ps1\", \"ps11\", \"ps11xml\", \"ps1xml\", \"ps2\",\n  \"ps2xml\", \"psc1\", \"psc2\", \"pub\", \"py\", \"pyc\", \"pyo\", \"pyw\", \"pyz\",\n  \"pyzw\", \"rar\", \"reg\", \"rev\", \"rtf\", \"scf\", \"scpt\", \"scr\", \"sct\",\n  \"searchConnector-ms\", \"service\", \"settingcontent-ms\", \"sh\", \"shb\", \"shs\",\n  \"shtm\", \"shtml\", \"sldm\", \"slk\", \"so\", \"spl\", \"stm\", \"svg\", \"swf\", \"sys\",\n  \"tar\", \"theme\", \"themepack\", \"timer\", \"uif\", \"url\", \"uue\", \"vb\", \"vbe\",\n  \"vbs\", \"vhd\", \"vhdx\", \"vxd\", \"wbk\", \"website\", \"wim\", \"wiz\", \"ws\", \"wsc\",\n  \"wsf\", \"wsh\", \"xla\", \"xlam\", \"xlc\", \"xll\", \"xlm\", \"xls\", \"xlsb\", \"xlsm\",\n  \"xlt\", \"xltm\", \"xlw\", \"xnk\", \"xps\", \"xsl\", \"xz\", \"z\"\n)\n# Create the policy\nNew-MalwareFilterPolicy @Policy -FileTypes $L2Extensions\n# Create the rule for all accepted domains\n$Rule = @{\n  Name                = $Policy.Name\n  Enabled             = $false\n  MalwareFilterPolicy = $Policy.Name\n  RecipientDomainIs   = (Get-AcceptedDomain).Name\n  Priority            = 0\n}\nNew-MalwareFilterRule @Rule\n\n3. When prepared enable the rule either through the UI or PowerShell.",
    "code": {
      "powerShell": null,
      "iac": null,
      "terraform": null,
      "other": null
    }
  },
  "recommendation": null,
  "references": [
    "https://learn.microsoft.com/en-us/powershell/module/exchange/getmalwarefilterpolicy?view=exchange-ps",
    "https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/antimalware-policies-configure?view=o365-worldwide",
    "https://learn.microsoft.com/en-us/office/compatibility/office-file-format-reference"
  ],
  "compliance": [
    {
      "name": "CIS Microsoft 365 Foundations",
      "version": "5.0.0",
      "reference": "8.3.1" 
    }
  ],
  "level": "high", 
  "tags": [
    "CIS Microsoft 365 Foundations 5.0.0 8.3.1",
    "Exchange Online",
    "Malware Protection"
  ],
  "rule": {
    "path": "Get-MonkeyEXOMalwareFilterPolicy",
    "subPath": null,
    "selectCondition": "[?enableFileFilter -ne 'True']", 
    "query": [],
    "shouldExist": null,
    "returnObject": null,
    "removeIfNotExists": null
  },
  "output": {
    "html": {
      "data": {
        "properties": {
          "name": "Policy Name",
          "enableFileFilter": "Common Attachment Filter Enabled",
          "fileTypes": "Blocked File Types"
        },
        "expandObject": null
      },
      "table": "Normal",
      "decorate": [
        {
          "ItemName": "Common Attachment Filter Enabled",
          "ItemValue": "False",
          "className": "badge bg-danger larger-badge"
        }
      ],
      "emphasis": [],
      "actions": {
        "objectData": {
          "properties": ["*"],
          "expandObject": null,
          "limit": null
        },
        "showGoToButton": "True",
        "showModalButton": "True",
        "directLink": null
      }
    },
    "text": {
      "data": {
        "properties": {},
        "expandObject": null
      },
      "status": {
        "keyName": [],
        "message": "Comprehensive attachment filtering (Common Attachment Types Filter) is not enabled or not configured with a comprehensive list of extensions in one or more Malware Filter Policies.",
        "defaultMessage": null
      },
      "properties": {
        "resourceName": "name",
        "resourceId": "identity",
        "resourceType": "Microsoft.Exchange.Management.SystemConfigurationTasks.MalwareFilterPolicy"
      },
      "onlyStatus": false
    }
  },
  "idSuffix": "exchange-lack-of-comprehensive-attachment-filtering",
  "notes": ["This control is similar to 2.1.11. The rule `[?enableFileFilter -ne 'True']` checks if the basic filter is off. A more advanced check would verify the list of `fileTypes` against the comprehensive list, which is complex for a simple selectCondition."],
  "categories": []
}