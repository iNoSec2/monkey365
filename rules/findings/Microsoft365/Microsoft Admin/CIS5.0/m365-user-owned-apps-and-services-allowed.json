{
  "args": [],
  "provider": "Microsoft365",
  "serviceType": "Microsoft Admin",
  "serviceName": "Microsoft 365",
  "displayName": "Ensure 'User owned apps and services' is restricted",
  "description": "By default, users can install add-ins in their Microsoft Word, Excel, and PowerPoint applications, allowing data access within the application.\n\nDo not allow users to install add-ins in Word, Excel, or PowerPoint.",
  "rationale": "Attackers commonly use vulnerable and custom-built add-ins to access data in user applications.\n\nWhile allowing users to install add-ins by themselves does allow them to easily acquire useful add-ins that integrate with Microsoft applications, it can represent a risk if not used and monitored carefully.\n\nDisable future user's ability to install add-ins in Microsoft Word, Excel, or PowerPoint helps reduce your threat-surface and mitigate this risk.",
  "impact": "Implementation of this change will impact both end users and administrators. End users will not be able to install add-ins that they may want to install.",
  "remediation": {
    "text": "To remediate using the UI:\n1. Navigate to Microsoft 365 admin center https://admin.microsoft.com.\n2. Click to expand Settings > Org settings.\n3. In Services select User owned apps and services.\n4. Uncheck Let users access the Office Store and Let users start trials on behalf of your organization.\n5. Click Save.\n\nTo remediate using PowerShell\n1. Connect to the Microsoft Graph service using Connect-MgGraph -Scopes \"OrgSettings-AppsAndServices.ReadWrite.All\".\n2. Run the following Microsoft Graph PowerShell commands:\n   $uri = \"https://graph.microsoft.com/beta/admin/appsAndServices\"\n   $body = @{\n     \"Settings\" = @{\n       \"isAppAndServicesTrialEnabled\" = $false\n       \"isOfficeStoreEnabled\"       = $false\n     }\n   } | ConvertTo-Json\n   Invoke-MgGraphRequest -Method PATCH -Uri $uri -Body $body",
    "code": {
      "powerShell": null,
      "iac": null,
      "terraform": null,
      "other": null
    }
  },
  "recommendation": null,
  "references": [
    "https://learn.microsoft.com/en-us/microsoft-365/admin/manage/manage-addinsin-the-admin-center?view=o365-worldwide#manage-add-in-downloads-byturning-onoff-the-office-store-across-all-apps-except-outlook"
  ],
  "compliance": [
    {
      "name": "CIS Microsoft 365 Foundations",
      "version": "5.0.0",
      "reference": "1.3.4"
    }
  ],
  "level": "medium",
  "tags": [
    "CIS Microsoft 365 Foundations 5.0.0 1.3.4",
    "Microsoft Admin"
  ],
  "rule": {
    "path": "Get-MonkeyM365ThirdPartyStorageConfig",
    "subPath": null,
    "selectCondition": "[?value.LetUsersAccessTheOfficeStore -ne 'False']",
    "query": [],
    "shouldExist": null,
    "returnObject": null,
    "removeIfNotExists": null
  },
  "output": {
    "html": {
      "data": {
        "properties": {
          "LetUsersAccessTheOfficeStore": "Users Can Access Office Store",
          "LetUsersStartTrials": "Users Can Start Trials"
        },
        "expandObject": null
      },
      "table": "Normal",
      "decorate": [
        {
          "ItemName": "Users Can Access Office Store",
          "ItemValue": "True",
          "className": "badge bg-danger larger-badge"
        }
      ],
      "emphasis": [],
      "actions": {
        "objectData": {
          "properties": ["*"],
          "expandObject": null,
          "limit": null
        },
        "showGoToButton": "False", 
        "showModalButton": "True",
        "directLink": null
      }
    },
    "text": {
      "data": {
        "properties": {},
        "expandObject": null
      },
      "status": {
        "keyName": [],
        "message": "User owned apps and services (Office Store access) is not restricted.",
        "defaultMessage": null
      },
      "properties": {
        "resourceName": "OrgSettings",
        "resourceId": "AppsAndServices",
        "resourceType": "Microsoft.Admin.OrgSettings"
      },
      "onlyStatus": true 
    }
  },
  "idSuffix": "m365-user-owned-apps-and-services-allowed",
  "notes": [],
  "categories": []
}